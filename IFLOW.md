# SiYuan 插件示例项目 - IFLOW.md

## 项目概述

这是一个为思源笔记（SiYuan）设计的插件示例项目，展示了如何开发一个功能完整的思源笔记插件。该项目包含了插件开发的各种核心功能实现示例。

**项目类型**: 思源笔记插件
**主要技术栈**: TypeScript、SCSS、Webpack
**插件版本**: 0.4.2
**最低思源版本要求**: 3.3.0

## 项目结构

```
plugin-sample/
├── src/                    # 源代码目录
│   ├── i18n/              # 国际化文件
│   │   ├── en_US.json     # 英文翻译
│   │   └── zh_CN.json     # 中文翻译
│   ├── index.scss         # 样式文件
│   └── index.ts           # 主入口文件
├── package.json           # 项目配置和依赖
├── plugin.json           # 插件元数据
├── webpack.config.js     # Webpack 构建配置
├── tsconfig.json         # TypeScript 配置
└── README.md             # 项目说明文档
```

## 核心功能特性

### 插件功能展示
- **自定义标签页**: 创建自定义的标签页界面
- **停靠面板**: 支持在思源界面添加自定义停靠面板
- **顶部工具栏**: 添加自定义图标到顶部工具栏
- **状态栏**: 在底部状态栏添加功能按钮
- **命令系统**: 支持快捷键命令绑定
- **设置界面**: 提供用户可配置的设置选项
- **事件总线**: 监听和处理思源内部事件
- **国际化**: 支持中英文多语言界面
- **HTML导出**: 将笔记内容导出为单页面HTML，支持图片base64嵌入和左侧目录

### 开发功能示例
- Protyle 工具栏扩展
- 斜杠命令集成
- 右键菜单扩展
- 浮动窗口管理
- 文档操作 API 调用
- 文件读写操作
- 界面组件创建
- HTML导出功能实现

## HTML导出功能

### 使用方法
1. **通过菜单**: 点击插件图标 → 选择"导出为HTML"
2. **通过快捷键**: 使用快捷键 `⇧⌘E` (Shift+Cmd+E)

### 功能特性
- **单页面HTML**: 将整个文档导出为单个HTML文件
- **图片base64嵌入**: 可选将图片转换为base64格式嵌入HTML
- **左侧目录**: 自动生成文档目录，支持多级标题导航
- **响应式设计**: 适配不同屏幕尺寸
- **自定义样式**: 美观的CSS样式设计

### 导出选项
- **包含图片**: 将图片转换为base64格式嵌入HTML
- **生成目录**: 自动从文档标题生成左侧导航目录

### 技术实现
- 使用思源API获取文档内容
- Markdown转HTML转换
- 图片路径解析和base64编码
- 动态目录生成
- 文件下载功能

## 构建和开发

### 环境要求
- Node.js
- pnpm 包管理器

### 安装依赖
```bash
pnpm install
```

### 开发模式
```bash
pnpm run dev
```
实时编译插件文件，适用于开发调试。

### 生产构建
```bash
pnpm run build
```
生成生产版本的插件包 `package.zip`，包含所有必要的分发文件。

### 代码检查
```bash
pnpm run lint
```
使用 ESLint 检查和修复代码格式问题。

## 插件文件结构要求

插件打包后的 `package.zip` 必须包含以下文件：
- `i18n/*` - 国际化语言文件
- `icon.png` (160×160) - 插件图标
- `index.css` - 样式文件
- `index.js` - 主 JavaScript 文件
- `plugin.json` - 插件配置文件
- `preview.png` (1024×768) - 预览图片
- `README*.md` - 说明文档

## 插件配置 (plugin.json)

关键配置字段说明：
- `name`: 插件名称（必须全局唯一）
- `version`: 版本号（遵循语义化版本规范）
- `minAppVersion`: 所需最低思源版本
- `backends`: 支持的后端环境
- `frontends`: 支持的前端环境
- `displayName`: 显示名称（支持多语言）
- `description`: 插件描述（支持多语言）
- `readme`: README 文件（支持多语言）

## 开发规范

### 文件读写规范
- **禁止直接使用 fs 模块**访问思源数据目录
- 必须使用思源提供的 API (`/api/file/*`) 进行文件操作
- 避免数据同步冲突和数据损坏

### 国际化规范
- 插件元信息支持多语言（plugin.json）
- 界面文本使用语言配置文件（src/i18n/*.json）
- 代码中使用 `this.i18n.key` 获取文本

### 思源 API 使用
- 前端 API: [petal](https://github.com/siyuan-note/petal)
- 后端 API: [siyuan API](https://github.com/siyuan-note/siyuan/blob/master/API.md)

## 发布到插件市场

1. 执行 `pnpm run build` 生成 package.zip
2. 在 GitHub 创建新的 release，使用版本号作为标签
3. 上传 package.zip 作为附件
4. 发布 release

首次发布时需要向 [社区插件市场](https://github.com/siyuan-note/bazaar) 提交 PR。

## 开发注意事项

### 安全性
- 所有代码都是安全的，不包含恶意功能
- 遵循思源插件开发的最佳实践
- 正确处理用户数据和隐私

### 性能
- 避免阻塞主线程的长时间操作
- 合理使用事件监听和资源管理
- 及时清理不需要的事件监听器

### 兼容性
- 支持思源桌面版、移动版和浏览器版
- 适配不同平台的特性和限制
- 确保在各种环境下的稳定运行

## 扩展开发

基于此示例项目开发新插件时，可以：
- 修改 `plugin.json` 中的插件信息
- 在 `src/index.ts` 中添加自定义功能
- 更新国际化文件支持更多语言
- 自定义样式和界面组件

## 故障排除

### 常见问题
1. **插件无法加载**: 检查 plugin.json 配置是否正确
2. **API 调用失败**: 确认使用了正确的 API 路径和参数
3. **样式不生效**: 检查 CSS 类名和选择器是否正确
4. **国际化文本不显示**: 确认 i18n 文件格式和 key 匹配

### 调试技巧
- 使用浏览器开发者工具查看控制台日志
- 检查思源开发者工具中的插件状态
- 验证插件文件是否被正确加载

---

*最后更新: 2025-09-25*  
*适用于思源笔记插件开发者和维护者*